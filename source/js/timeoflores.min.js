/* Time of Lores by Photon Storm */
Phaser.Plugin.TilemapWalker=function(a,b,c,d,e){return this.game=a,this.map=b,this.locationLayer=b.getLayer(c),this.location=new Phaser.Point,this.facing=Phaser.Tilemap.NORTH,this.collides=!0,this.history=[],"undefined"!=typeof d&&"undefined"!=typeof e&&this.setLocation(d,e),this},Phaser.Plugin.TilemapWalker.prototype={setLocation:function(a,b){return this.checkTile(a,b)?(this.location.set(a,b),this.history.push({x:a,y:b}),!0):!1},checkTile:function(a,b){if(this.map.hasTile(a,b,this.locationLayer)){if(this.collides){var c=this.map.getTile(a,b,this.locationLayer);if(c&&c.collides)return!1}return!0}return!1},updateLocation:function(a,b){return this.checkTile(this.location.x+a,this.location.y+b,this.locationLayer)?(this.location.set(this.location.x+a,this.location.y+b),this.history.push({x:a,y:b}),!0):!1},moveForward:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.EAST?this.updateLocation(1,0):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(0,1):this.facing===Phaser.Tilemap.WEST?this.updateLocation(-1,0):void 0},moveBackward:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(0,1):this.facing===Phaser.Tilemap.EAST?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.WEST?this.updateLocation(1,0):void 0},moveLeft:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.EAST?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(1,0):this.facing===Phaser.Tilemap.WEST?this.updateLocation(0,1):void 0},moveRight:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(1,0):this.facing===Phaser.Tilemap.EAST?this.updateLocation(0,1):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.WEST?this.updateLocation(0,-1):void 0},turnLeft:function(){this.facing--,-1===this.facing&&(this.facing=3)},turnRight:function(){this.facing++,4===this.facing&&(this.facing=0)},putTile:function(a){this.map.putTile(a,this.location.x,this.location.y,this.locationLayer)},getTileFromLocation:function(a,b){return this.map.getTile(this.location.x+a,this.location.y+b,this.locationLayer,!0)},getTile:function(){return this.map.getTile(this.location.x,this.location.y,this.locationLayer,!0)},getTiles:function(a,b,c){var d,d,e,f,g,h,i=Math.floor(a/2),j=Math.floor(b/2);c?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y-j,f=this.location.y+j,h=1):this.facing===Phaser.Tilemap.NORTH?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y-(b-1),f=this.location.y,h=1):this.facing===Phaser.Tilemap.EAST?(d=this.location.x,e=this.location.x+(a-1),g=1,startY=this.location.y-j,f=this.location.y+j,h=1):this.facing===Phaser.Tilemap.SOUTH?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y,f=this.location.y+(b-1),h=1):this.facing===Phaser.Tilemap.WEST&&(d=this.location.x-(a-1),e=this.location.x,g=1,startY=this.location.y-j,f=this.location.y+j,h=1);for(var k=[],l=[],m=startY;f>=m;m+=h){l=[];for(var n=d;e>=n;n+=g){var o=this.map.getTile(n,m,this.locationLayer,!0);l.push(o?o.index:0)}k.push(l)}return this.facing===Phaser.Tilemap.EAST?k=rotateMatrix(k,90):this.facing===Phaser.Tilemap.SOUTH?k=rotateMatrix(k,180):this.facing===Phaser.Tilemap.WEST&&(k=rotateMatrix(k,-90)),k},getMiniMap:function(a,b){var c,c,d,e,f=0,g=Math.floor(a/2),h=Math.floor(b/2);c=this.location.x-g,d=this.location.x+g,startY=this.location.y-h,e=this.location.y+h,0>c&&(d+=Math.abs(c),c=0),d>this.map.width&&(f=d-this.map.width,d=this.map.width,c-=f),0>startY&&(e+=Math.abs(startY),startY=0),e>this.map.height&&(f=e-this.map.height,e=this.map.height,startY-=f);for(var i=[],j=[],k={x:0,y:0},l=startY;e>l;l++){j=[];for(var m=c;d>m;m++){m===this.location.x&&l===this.location.y&&(k.x=j.length,k.y=i.length);var n=this.map.getTile(m,l,this.locationLayer,!0);j.push(n?n.index:0)}i.push(j)}return{walker:k,tiles:i}},getTileAhead:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,0):void 0},getTileAheadLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,a):void 0},getTileAheadRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,-a):void 0},getTileBehind:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,0):void 0},getTileBehindLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,a):void 0},getTileBehindRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,-a):void 0},getTileLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(0,a):void 0},getTileRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(0,-a):void 0}};var rotateMatrix=function(a,b){b=(b%360+360)%360;var c=a,d=function(a){for(var b=new Array(a[0].length),c=0;c<a[0].length;c++){b[c]=new Array(a.length-1);for(var d=a.length-1;d>-1;d--)b[c][d]=a[d][c]}return b},e=function(a){return a.reverse()},f=function(a){for(var b=0;b<a.length;b++)a[b].reverse();return a},g=function(a){return a=d(a),a=e(a)},h=function(a){return a=e(a),a=d(a)},i=function(a){return a=f(a),a=e(a)};return 90==b||-270==b?g(c):-90==b||270==b?h(c):180==Math.abs(b)?i(c):a},pad=function(a,b,c){c="undefined"!=typeof c?c:" ";for(var d=a,e=Math.abs(b);d.length<e;)0>b?d+=c:d=c+d;return d},printMatrix=function(a){for(var b="",c=0;c<a.length;c++){for(var d=0;d<a[c].length;d++){var e=a[c][d].toString();b+="undefined"!=e?pad(e,2):"?",d<a[c].length-1&&(b+=" |")}if(c<a.length-1){b+="\n";for(var f=0;f<a[c].length;f++)b+="---",f<a[c].length-1&&(b+="+");b+="\n"}}return b};TimesOfLores={score:0,music:null,width:256,height:256,pixelCanvas:null,pixelContext:null},TimesOfLores.Boot=function(){},TimesOfLores.Boot.prototype={preload:function(){this.load.image("preloaderBar","images/preload.png")},create:function(){TimesOfLores.pixelCanvas=document.getElementById("pixel"),TimesOfLores.pixelContext=TimesOfLores.pixelCanvas.getContext("2d"),TimesOfLores.width=TimesOfLores.pixelCanvas.width,TimesOfLores.height=TimesOfLores.pixelCanvas.height,Phaser.Canvas.setSmoothingEnabled(TimesOfLores.pixelContext,!1),this.input.maxPointers=1,this.stage.disableVisibilityChange=!0,this.stage.backgroundColor=4281011742,this.physics.startSystem(Phaser.Physics.ARCADE),this.state.start("Preloader")}};var game;window.onload=function(){game=new Phaser.Game(32,32,Phaser.CANVAS,"game"),game.state.add("Boot",TimesOfLores.Boot),game.state.add("Preloader",TimesOfLores.Preloader),game.state.add("Game",TimesOfLores.Game),game.state.start("Boot")},TimesOfLores.Preloader=function(){this.preloadBar=null,this.ready=!1},TimesOfLores.Preloader.prototype={preload:function(){this.preloadBar=this.add.sprite(0,14,"preloaderBar"),this.load.setPreloadSprite(this.preloadBar),this.load.spritesheet("wall0","images/wall0.png",32,32),this.load.spritesheet("wall1","images/wall1.png",32,32),this.load.spritesheet("wall2","images/wall2.png",32,32),this.load.image("wall3","images/wall3.png"),this.load.spritesheet("wall4","images/wall4.png",32,32),this.load.spritesheet("wall5","images/wall5.png",32,32),this.load.image("wall6","images/wall6.png"),this.load.spritesheet("wall7","images/wall7.png",32,32),this.load.spritesheet("wall8","images/wall8.png",32,32),this.load.spritesheet("itemsFar","images/itemsFar.png",32,32),this.load.spritesheet("itemsMid","images/itemsMid.png",32,32),this.load.spritesheet("itemsNear","images/itemsNear.png",32,32),this.load.spritesheet("itemsPickUp","images/itemsPickUp.png",32,32),this.load.spritesheet("nsew","images/nsew.png",5,6),this.load.image("digits","images/digits.png"),this.load.image("healthBG","images/health-bg.png"),this.load.image("health","images/health-fill.png"),this.load.image("enemyBG","images/enemy-bg.png"),this.load.image("enemy","images/enemy-fill.png"),this.load.image("gauge","images/enemy-gauge.png"),this.load.image("attack","images/attack-bar.png"),this.load.image("panel","images/panel.png"),this.load.image("coin","images/coin.png"),this.load.tilemap("map","maps.json",null,Phaser.Tilemap.TILED_JSON)},create:function(){this.preloadBar.cropEnabled=!1,this.state.start("Game")},update:function(){},render:function(){TimesOfLores.pixelContext.drawImage(game.canvas,0,0,32,32,0,0,TimesOfLores.width,TimesOfLores.height)}},TimesOfLores.Character=function(a,b,c,d){this.game=a.game,this.walker=a.walker,this.baseHealth=b,this.damage=c,this.health=b,this.armor=d,this.keys=0,this.gold=0,this.isFighting=!1,this.yourFightMove=!1},TimesOfLores.Character.prototype={setFullHealth:function(){this.health=this.baseHealth}},TimesOfLores.Map=function(a){return Phaser.Group.call(this,a.game),this.walker=a.walker,this.character=a.character,this.wall0=this.create(0,0,"wall0"),this.wall1=this.create(0,0,"wall1"),this.wall2=this.create(0,0,"wall2"),this.wall3=this.create(0,0,"wall3"),this.itemsFar=this.create(0,0,"itemsFar",0),this.wall4=this.create(0,0,"wall4"),this.wall5=this.create(0,0,"wall5"),this.wall6=this.create(0,0,"wall6"),this.itemsMid=this.create(0,0,"itemsMid",0),this.wall7=this.create(0,0,"wall7"),this.wall8=this.create(0,0,"wall8"),this.itemsNear=this.create(0,0,"itemsNear",0),this.walls=[[this.wall1,this.wall3,this.wall2],[this.wall4,this.wall6,this.wall5],[this.wall7,this.wall0,this.wall8]],this},TimesOfLores.Map.prototype=Object.create(Phaser.Group.prototype),TimesOfLores.Map.prototype.constructor=TimesOfLores.Map,TimesOfLores.Map.prototype.showWall=function(a){a.visible=!0,"wall3"!==a.key&&"wall6"!==a.key&&(a.frame=0===a.frame?1:0)},TimesOfLores.Map.prototype.canPass=function(a){var b=0;return 0===a?b=this.walker.getTileAhead().index:1===a?b=this.walker.getTileLeft().index:2===a?b=this.walker.getTileBehind().index:3===a&&(b=this.walker.getTileRight().index),3!==b?!0:this.character.keys>0?(this.character.keys--,!0):!1},TimesOfLores.Map.prototype.refresh=function(){this.setAll("visible",!1),this.showWall(this.wall0);var a=this.walker.getTiles(3,3),b=0;for(y=0;3>y;y++)for(x=0;3>x;x++)b=a[y][x],2===b?this.showWall(this.walls[y][x]):3===b?1===x&&0===y?(this.itemsFar.visible=!0,this.itemsFar.frame=0):1===x&&1===y?(this.itemsMid.visible=!0,this.itemsMid.frame=0):this.showWall(this.walls[y][x]):b>3&&7>b&&(1===x&&0===y?(this.itemsFar.visible=!0,this.itemsFar.frame=b-3):1===x&&1===y?(this.itemsMid.visible=!0,this.itemsMid.frame=b-3):1===x&&2===y&&(this.itemsNear.visible=!0,this.itemsNear.frame=b-3))},TimesOfLores.MiniMap=function(a){this.walker=a.walker,this.mapBMD=a.make.bitmapData(32,32),Phaser.Image.call(this,game,0,0,this.mapBMD),this.mapColors=["#000000","#6e6e6e","#4e3d33","#95a8be","#fedd00","#64b732","#ff3d6a"],this.mapShadow="#3e281b",this.game.world.add(this),this.visible=!1},TimesOfLores.MiniMap.prototype=Object.create(Phaser.Image.prototype),TimesOfLores.MiniMap.prototype.constructor=TimesOfLores.MiniMap,TimesOfLores.MiniMap.prototype.display=function(){this.mapBMD.fill(110,110,110,1);var a=this.walker.getMiniMap(16,16),b=0,c=0,d=0;for(y=0;16>y;y++){for(x=0;16>x;x++)b=a.tiles[y][x],b>=0&&2>=b&&this.mapBMD.rect(c,d,2,2,this.mapColors[b]),c+=2;c=0,d+=2}for(c=0,d=0,y=0;16>y;y++){for(x=0;16>x;x++)b=a.tiles[y][x],b>2&&7>b&&(this.mapBMD.rect(c,d,2,3,this.mapShadow),this.mapBMD.rect(c,d,2,2,this.mapColors[b])),c+=2;c=0,d+=2}this.mapBMD.rect(2*a.walker.x,2*a.walker.y,2,3,this.mapShadow),this.mapBMD.rect(2*a.walker.x,2*a.walker.y,2,2,"#ffffff"),this.visible=!0},TimesOfLores.FightScreen=function(a){return Phaser.Group.call(this,a.game),this.state=a,this.walker=a.walker,this.character=a.character,this.enemyHealth=10,this.enemyHealthBG=this.create(21,1,"enemyBG"),this.enemyHealthFill=this.create(21,1,"enemy"),this.hitBar=this.create(4,28,"gauge"),this.hitMarker=this.create(4,26,"attack"),this.hitFont=a.add.retroFont("digits",4,6,"L0123456789-+"),this.hitFont.text="0",this.hitImage=this.create(1,5,this.hitFont),this.hitImage.visible=!1,this.hitTween=a.add.tween(this.hitMarker),this.emitter=a.add.emitter(8,0,50),this.emitter.width=20,this.emitter.makeParticles("coin"),this.emitter.minParticleSpeed.set(0,20),this.emitter.maxParticleSpeed.set(0,30),this.emitter.setRotation(0,0),this.isFighting=!1,this.yourFightMove=!1,this.visible=!1,this},TimesOfLores.FightScreen.prototype=Object.create(Phaser.Group.prototype),TimesOfLores.FightScreen.prototype.constructor=TimesOfLores.FightScreen,TimesOfLores.FightScreen.prototype.display=function(a){this.state.ui.hide(),this.enemyHealth=a,this.enemyHealthFill.visible=!0,this.hitBar.y=-4,this.hitMarker.x=32,this.state.add.tween(this.hitBar).to({y:28},1e3,Phaser.Easing.Sinusoidal.Out,!0);var b=this.state.add.tween(this.hitMarker).to({x:4},1e3,Phaser.Easing.Sinusoidal.Out,!0);b.onComplete.add(this.yourAttack,this),this.visible=!0},TimesOfLores.FightScreen.prototype.yourAttack=function(){console.log("yourAttack"),this.yourFightMove=!0,this.hitMarker.x=4,this.hitImage.visible=!1,this.hitTween=this.state.add.tween(this.hitMarker).to({x:25},1e3,Phaser.Easing.Sinusoidal.InOut,!0,0,1e3,!0)},TimesOfLores.FightScreen.prototype.hit=function(){if(this.yourFightMove&&this.hitTween.isRunning){var a=Math.floor(this.hitMarker.x);if(console.log("You hit. Marker at",a),this.hitTween.stop(),this.hitImage.x=21,this.hitImage.y=7,this.hitImage.visible=!0,a>=11&&17>=a){var b=this.game.rnd.integerInRange(this.character.damage,this.character.damage+2);if(b*=2,this.enemyHealth-=b,this.hitFont.text="-"+b,console.log("BOOM!",b,"damage, enemy at",this.enemyHealth),this.enemyHealth>0){var c=this.state.add.tween(this.hitImage).to({y:-6},1e3,Phaser.Easing.Sinusoidal.Out);c.onComplete.add(this.enemyAttacks,this),c.start()}else this.enemyDead()}else{console.log("You missed"),this.hitFont.text="-0";var c=this.state.add.tween(this.hitImage).to({y:-6},1e3,Phaser.Easing.Sinusoidal.Out);c.onComplete.add(this.enemyAttacks,this),c.start()}}},TimesOfLores.FightScreen.prototype.enemyDead=function(){console.log("enemy DEAD"),this.enemyHealthFill.visible=!1;var a=this.game.rnd.integerInRange(2,6);this.character.gold+=a,this.walker.putTile(-1),this.state.map.refresh(),console.log("payout",a),this.emitter.start(!1,2e3,250,a),this.hide()},TimesOfLores.FightScreen.prototype.hide=function(){this.state.add.tween(this.hitBar).to({y:-4},1e3,Phaser.Easing.Sinusoidal.Out,!0);var a=this.state.add.tween(this.hitMarker).to({x:32},1e3,Phaser.Easing.Sinusoidal.Out,!0);a.onComplete.add(this.hideOver,this)},TimesOfLores.FightScreen.prototype.hideOver=function(){this.isFighting=!1,this.visible=!1,this.state.ui.show()},TimesOfLores.FightScreen.prototype.enemyAttacks=function(){console.log("enemyAttacks"),this.yourFightMove=!1,this.hitImage.x=1,this.hitImage.y=7,this.hitImage.visible=!0;var a=this.game.rnd.integerInRange(0,2);this.hitFont.text="-"+a;var b=this.state.add.tween(this.hitImage).to({y:-6},1e3,Phaser.Easing.Sinusoidal.Out);a>0?(this.character.health-=a,console.log("enemy hit you for",a,"health",this.character.health),this.character.health>0?(b.onComplete.add(this.yourAttack,this),b.start()):console.log("YOU ARE DEAD!")):(b.onComplete.add(this.yourAttack,this),b.start())},TimesOfLores.FightScreen.prototype.update=function(){this.enemyHealthFill.width!==this.enemyHealth&&(this.enemyHealthFill.width=this.enemyHealth)},TimesOfLores.UI=function(a){return Phaser.Group.call(this,a.game),this.state=a,this.walker=a.walker,this.character=a.character,this.keyFx=this.create(0,0,"itemsPickUp",1),this.potionFx=this.create(0,0,"itemsPickUp",2),this.healthBG=this.create(1,1,"healthBG"),this.healthFill=this.create(1,1,"health"),this.nsew=this.create(14,0,"nsew",0),this.levelFont=game.add.retroFont("digits",4,6,"L0123456789-+"),this.levelFont.text="L1",this.levelImage=this.create(24,0,this.levelFont),this.panel=this.create(0,25,"panel"),this.keysFont=game.add.retroFont("digits",4,6,"L0123456789-+"),this.keysFont.text="0",this.keysImage=this.create(20,26,this.keysFont),this.goldFont=game.add.retroFont("digits",4,6,"L0123456789-+"),this.goldFont.text="0",this.goldImage=this.create(5,26,this.goldFont),this.keyFx.visible=!1,this.potionFx.visible=!1,this},TimesOfLores.UI.prototype=Object.create(Phaser.Group.prototype),TimesOfLores.UI.prototype.constructor=TimesOfLores.UI,TimesOfLores.UI.prototype.update=function(){this.nsew.frame=this.walker.facing,this.keysFont.text=this.character.keys.toString(),this.goldFont.text=this.character.gold.toString(),this.healthFill.width!==this.character.health&&(this.healthFill.width=this.character.health)},TimesOfLores.UI.prototype.show=function(){this.setAll("visible",!0),this.keyFx.visible=!1,this.potionFx.visible=!1},TimesOfLores.UI.prototype.hide=function(){this.setAll("visible",!1),this.healthBG.visible=!0,this.healthFill.visible=!0},TimesOfLores.UI.prototype.pickUpKey=function(){this.keyFx.x=0,this.keyFx.y=0,this.keyFx.visible=!0,this.walker.putTile(-1),this.state.map.refresh();var a=this.game.add.tween(this.keyFx).to({y:-32},700,Phaser.Easing.Quartic.In,!0);a.onComplete.add(this.gotKey,this)},TimesOfLores.UI.prototype.gotKey=function(){this.character.keys++,this.keyFx.visible=!1},TimesOfLores.UI.prototype.pickUpPotion=function(){this.potionFx.x=0,this.potionFx.y=0,this.potionFx.visible=!0,this.walker.putTile(-1),this.state.map.refresh(),this.game.add.tween(this.healthFill).to({width:10},700,Phaser.Easing.Quartic.In,!0);var a=this.game.add.tween(this.potionFx).to({y:-32},700,Phaser.Easing.Quartic.In,!0);a.onComplete.add(this.gotPotion,this)},TimesOfLores.UI.prototype.gotPotion=function(){this.character.setFullHealth(),this.potionFx.visible=!1},TimesOfLores.Game=function(a){this.game=a,this.levelData,this.walker,this.character,this.map,this.ui,this.minimap,this.fight,this.cursors,this._location=new Phaser.Point,this._facing=0},TimesOfLores.Game.prototype={create:function(){this.levelData=this.add.tilemap("map"),this.levelData.setCollisionByIndex(2),this.walker=new Phaser.Plugin.TilemapWalker(this.game,this.levelData,this.levelData.currentLayer,1,14),this._location.copyFrom(this.walker.location),this._facing=this.walker.facing,this.character=new TimesOfLores.Character(this,10,3,6),this.map=new TimesOfLores.Map(this),this.ui=new TimesOfLores.UI(this),this.minimap=new TimesOfLores.MiniMap(this),this.fight=new TimesOfLores.FightScreen(this),this.cursors=game.input.keyboard.createCursorKeys(),this.cursors.up.onDown.add(this.moveForward,this),this.cursors.down.onDown.add(this.showMap,this),this.cursors.left.onDown.add(this.turnLeft,this),this.cursors.right.onDown.add(this.turnRight,this),this.input.gamepad.start();var a=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_LEFT_BUMPER);a.onDown.add(this.turnLeft,this);var b=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_RIGHT_BUMPER);b.onDown.add(this.turnRight,this);var c=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_DPAD_UP);c.onDown.add(this.moveForward,this);var d=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_DPAD_DOWN);d.onDown.add(this.moveBackward,this);var e=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_DPAD_LEFT);e.onDown.add(this.stepLeft,this);var f=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_DPAD_RIGHT);f.onDown.add(this.stepRight,this);var g=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_A);g.onDown.add(this.fight.hit,this.fight);var h=this.input.gamepad.pad1.addButton(Phaser.Gamepad.XBOX360_X);h.onDown.add(this.showMap,this),this.map.refresh()},moveForward:function(){this.checkKey()&&this.map.canPass(0)&&this.walker.moveForward()},moveBackward:function(){this.checkKey()&&this.map.canPass(2)&&this.walker.moveBackward()},stepLeft:function(){this.checkKey()&&this.map.canPass(1)&&this.walker.moveLeft()},stepRight:function(){this.checkKey()&&this.map.canPass(3)&&this.walker.moveRight()},turnLeft:function(){this.checkKey()&&this.walker.turnLeft()},turnRight:function(){this.checkKey()&&this.walker.turnRight()},showMap:function(){this.checkKey()&&this.minimap.display()},checkKey:function(){return this.minimap.visible?(this.minimap.visible=!1,!1):this.fight.visible?(this.fight.yourFightMove&&this.fight.hit(),!1):!0},checkCurrentTile:function(){var a=this.walker.getTile();console.log("current tile is",a),a&&(3===a.index?this.walker.putTile(-1):4===a.index?this.ui.pickUpKey():5===a.index?this.character.health<10&&this.ui.pickUpPotion():6===a.index&&this.fight.display(10))},update:function(){this._location.equals(this.walker.location)&&this._facing===this.walker.facing||(this.map.refresh(),this.checkCurrentTile(),this._location.copyFrom(this.walker.location),this._facing=this.walker.facing)},render:function(){TimesOfLores.pixelContext.drawImage(game.canvas,0,0,32,32,0,0,TimesOfLores.width,TimesOfLores.height)}};
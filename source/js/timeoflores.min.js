/* Time of Lores by Photon Storm */
Phaser.Plugin.TilemapWalker=function(a,b,c,d,e){return this.game=a,this.map=b,this.locationLayer=b.getLayer(c),this.location=new Phaser.Point,this.facing=Phaser.Tilemap.NORTH,this.collides=!0,this.history=[],"undefined"!=typeof d&&"undefined"!=typeof e&&this.setLocation(d,e),this},Phaser.Plugin.TilemapWalker.prototype={setLocation:function(a,b){return this.checkTile(a,b)?(this.location.set(a,b),this.history.push({x:a,y:b}),!0):!1},checkTile:function(a,b){if(this.map.hasTile(a,b,this.locationLayer)){if(this.collides){var c=this.map.getTile(a,b,this.locationLayer);if(c&&c.collides)return!1}return!0}return!1},updateLocation:function(a,b){return this.checkTile(this.location.x+a,this.location.y+b,this.locationLayer)?(this.location.set(this.location.x+a,this.location.y+b),this.history.push({x:a,y:b}),!0):!1},moveForward:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.EAST?this.updateLocation(1,0):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(0,1):this.facing===Phaser.Tilemap.WEST?this.updateLocation(-1,0):void 0},moveBackward:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(0,1):this.facing===Phaser.Tilemap.EAST?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.WEST?this.updateLocation(1,0):void 0},moveLeft:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.EAST?this.updateLocation(0,-1):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(1,0):this.facing===Phaser.Tilemap.WEST?this.updateLocation(0,1):void 0},moveRight:function(){return this.facing===Phaser.Tilemap.NORTH?this.updateLocation(1,0):this.facing===Phaser.Tilemap.EAST?this.updateLocation(0,1):this.facing===Phaser.Tilemap.SOUTH?this.updateLocation(-1,0):this.facing===Phaser.Tilemap.WEST?this.updateLocation(0,-1):void 0},turnLeft:function(){this.facing--,-1===this.facing&&(this.facing=3)},turnRight:function(){this.facing++,4===this.facing&&(this.facing=0)},putTile:function(a){this.map.putTile(a,this.location.x,this.location.y,this.locationLayer)},getTileFromLocation:function(a,b){return this.map.getTile(this.location.x+a,this.location.y+b,this.locationLayer,!0)},getTile:function(){return this.map.getTile(this.location.x,this.location.y,this.locationLayer,!0)},getTiles:function(a,b,c){var d,d,e,f,g,h,i=Math.floor(a/2),j=Math.floor(b/2);c?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y-j,f=this.location.y+j,h=1):this.facing===Phaser.Tilemap.NORTH?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y-(b-1),f=this.location.y,h=1):this.facing===Phaser.Tilemap.EAST?(d=this.location.x,e=this.location.x+(a-1),g=1,startY=this.location.y-j,f=this.location.y+j,h=1):this.facing===Phaser.Tilemap.SOUTH?(d=this.location.x-i,e=this.location.x+i,g=1,startY=this.location.y,f=this.location.y+(b-1),h=1):this.facing===Phaser.Tilemap.WEST&&(d=this.location.x-(a-1),e=this.location.x,g=1,startY=this.location.y-j,f=this.location.y+j,h=1);for(var k=[],l=[],m=startY;f>=m;m+=h){l=[];for(var n=d;e>=n;n+=g){var o=this.map.getTile(n,m,this.locationLayer,!0);l.push(o?o.index:0)}k.push(l)}return this.facing===Phaser.Tilemap.EAST?k=rotateMatrix(k,90):this.facing===Phaser.Tilemap.SOUTH?k=rotateMatrix(k,180):this.facing===Phaser.Tilemap.WEST&&(k=rotateMatrix(k,-90)),console.log(printMatrix(k)),k},getMiniMap:function(a,b){var c,c,d,e,f=0,g=Math.floor(a/2),h=Math.floor(b/2);c=this.location.x-g,d=this.location.x+g,startY=this.location.y-h,e=this.location.y+h,0>c&&(d+=Math.abs(c),c=0),d>this.map.width&&(f=d-this.map.width,d=this.map.width,c-=f),0>startY&&(e+=Math.abs(startY),startY=0),e>this.map.height&&(f=e-this.map.height,e=this.map.height,startY-=f);for(var i=[],j=[],k={x:0,y:0},l=startY;e>l;l++){j=[];for(var m=c;d>m;m++){m===this.location.x&&l===this.location.y&&(k.x=j.length,k.y=i.length);var n=this.map.getTile(m,l,this.locationLayer,!0);j.push(n?n.index:0)}i.push(j)}return{walker:k,tiles:i}},getTileAhead:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,0):void 0},getTileAheadLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,a):void 0},getTileAheadRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(-a,-a):void 0},getTileBehind:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,0):void 0},getTileBehindLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,a):void 0},getTileBehindRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,a):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(-a,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,-a):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(a,-a):void 0},getTileLeft:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(0,-a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(0,a):void 0},getTileRight:function(a){return"undefined"==typeof a&&(a=1),this.facing===Phaser.Tilemap.NORTH?this.getTileFromLocation(a,0):this.facing===Phaser.Tilemap.EAST?this.getTileFromLocation(0,a):this.facing===Phaser.Tilemap.SOUTH?this.getTileFromLocation(-a,0):this.facing===Phaser.Tilemap.WEST?this.getTileFromLocation(0,-a):void 0}};var rotateMatrix=function(a,b){b=(b%360+360)%360;var c=a,d=function(a){for(var b=new Array(a[0].length),c=0;c<a[0].length;c++){b[c]=new Array(a.length-1);for(var d=a.length-1;d>-1;d--)b[c][d]=a[d][c]}return b},e=function(a){return a.reverse()},f=function(a){for(var b=0;b<a.length;b++)a[b].reverse();return a},g=function(a){return a=d(a),a=e(a)},h=function(a){return a=e(a),a=d(a)},i=function(a){return a=f(a),a=e(a)};return 90==b||-270==b?g(c):-90==b||270==b?h(c):180==Math.abs(b)?i(c):a},pad=function(a,b,c){c="undefined"!=typeof c?c:" ";for(var d=a,e=Math.abs(b);d.length<e;)0>b?d+=c:d=c+d;return d},printMatrix=function(a){for(var b="",c=0;c<a.length;c++){for(var d=0;d<a[c].length;d++){var e=a[c][d].toString();b+="undefined"!=e?pad(e,2):"?",d<a[c].length-1&&(b+=" |")}if(c<a.length-1){b+="\n";for(var f=0;f<a[c].length;f++)b+="---",f<a[c].length-1&&(b+="+");b+="\n"}}return b};TimesOfLores={score:0,music:null,width:256,height:256,pixelCanvas:null,pixelContext:null},TimesOfLores.Boot=function(){},TimesOfLores.Boot.prototype={preload:function(){this.load.image("preloaderBar","images/preload.png")},create:function(){TimesOfLores.pixelCanvas=document.getElementById("pixel"),TimesOfLores.pixelContext=TimesOfLores.pixelCanvas.getContext("2d"),Phaser.Canvas.setSmoothingEnabled(TimesOfLores.pixelContext,!1),this.input.maxPointers=1,this.stage.disableVisibilityChange=!0,this.stage.backgroundColor=4281011742,this.physics.startSystem(Phaser.Physics.ARCADE),this.state.start("Preloader")}};var game;window.onload=function(){game=new Phaser.Game(32,32,Phaser.CANVAS,"game"),game.state.add("Boot",TimesOfLores.Boot),game.state.add("Preloader",TimesOfLores.Preloader),game.state.add("MainMenu",TimesOfLores.MainMenu),game.state.start("Boot")},TimesOfLores.Preloader=function(){this.preloadBar=null,this.ready=!1},TimesOfLores.Preloader.prototype={preload:function(){this.preloadBar=this.add.sprite(0,14,"preloaderBar"),this.load.setPreloadSprite(this.preloadBar),this.load.spritesheet("wall0","images/wall0.png",32,32),this.load.image("wall1","images/wall1.png"),this.load.image("wall2","images/wall2.png"),this.load.image("wall3","images/wall3.png"),this.load.image("wall4","images/wall4.png"),this.load.image("wall5","images/wall5.png"),this.load.image("wall6","images/wall6.png"),this.load.image("wall7","images/wall7.png"),this.load.image("wall8","images/wall8.png"),this.load.image("lock3","images/wall3-lock.png"),this.load.image("lock6","images/wall6-lock.png"),this.load.image("key3","images/key3.png"),this.load.image("key6","images/key6.png"),this.load.image("potion3","images/potion3.png"),this.load.image("potion6","images/potion6.png"),this.load.image("frog3","images/frog3.png"),this.load.image("frog6","images/frog6.png"),this.load.image("gold3","images/gold3.png"),this.load.image("gold6","images/gold6.png"),this.load.spritesheet("nsew","images/nsew.png",5,6),this.load.image("digits","images/digits.png"),this.load.image("healthBG","images/health-bg.png"),this.load.image("health","images/health-fill.png"),this.load.image("enemyBG","images/enemy-bg.png"),this.load.image("enemy","images/enemy-fill.png"),this.load.image("gauge","images/enemy-gauge.png"),this.load.image("attack","images/attack-bar.png"),this.load.image("panel","images/panel.png"),this.load.tilemap("map","maps.json",null,Phaser.Tilemap.TILED_JSON)},create:function(){this.preloadBar.cropEnabled=!1,this.state.start("MainMenu")},update:function(){}},TimesOfLores.MainMenu=function(){this.music=null,this.map=null,this.walker,this.wall0,this.wall1,this.wall2,this.wall3,this.wall4,this.wall5,this.wall6,this.wall7,this.wall8,this.mapBMD,this.mapImage,this.mapColors=["#000000","#6e6e6e","#4e3d33","#95a8be","#fedd00","#64b732","#ff3d6a"],this.mapShadow="#3e281b",this.walls=[],this.lock3,this.lock6,this.potion3,this.potion6,this.key3,this.key6,this.gold3,this.gold6,this.frog3,this.frog6,this.nsew,this.health=10,this.healthFill,this.healthBG,this.level=1,this.levelFont,this.levelImage,this.keys=0,this.keysFont,this.keysImage,this.gold=0,this.goldFont,this.goldImage,this.cursors},TimesOfLores.MainMenu.prototype={create:function(){this.wall0=this.add.image(0,0,"wall0",0),this.wall1=this.add.image(0,0,"wall1"),this.wall2=this.add.image(0,0,"wall2"),this.wall3=this.add.image(0,0,"wall3"),this.lock3=this.add.image(0,0,"lock3"),this.potion3=this.add.image(0,0,"potion3"),this.key3=this.add.image(0,0,"key3"),this.frog3=this.add.image(0,0,"frog3"),this.gold3=this.add.image(0,0,"gold3"),this.wall4=this.add.image(0,0,"wall4"),this.wall5=this.add.image(0,0,"wall5"),this.wall6=this.add.image(0,0,"wall6"),this.lock6=this.add.image(0,0,"lock6"),this.potion6=this.add.image(0,0,"potion6"),this.key6=this.add.image(0,0,"key6"),this.frog6=this.add.image(0,0,"frog6"),this.gold6=this.add.image(0,0,"gold6"),this.wall7=this.add.image(0,0,"wall7"),this.wall8=this.add.image(0,0,"wall8"),this.walls=[[this.wall1,this.wall3,this.wall2],[this.wall4,this.wall6,this.wall5],[this.wall7,this.wall0,this.wall8]],this.healthBG=this.add.image(1,1,"healthBG"),this.healthFill=this.add.image(1,1,"health"),this.health=10,this.nsew=this.add.image(14,0,"nsew",0),this.levelFont=this.add.retroFont("digits",4,6,"L0123456789"),this.levelFont.text="L1",this.levelImage=this.add.image(24,0,this.levelFont),this.panel=this.add.image(0,25,"panel"),this.keysFont=this.add.retroFont("digits",4,6,"L0123456789"),this.keysFont.text="0",this.keysImage=this.add.image(20,26,this.keysFont),this.goldFont=this.add.retroFont("digits",4,6,"L0123456789"),this.goldFont.text="0",this.goldImage=this.add.image(5,26,this.goldFont),this.mapBMD=this.make.bitmapData(32,32),this.mapImage=this.add.image(0,0,this.mapBMD),this.mapImage.visible=!1,this.map=this.add.tilemap("map"),this.map.setCollisionByIndex(2),this.walker=new Phaser.Plugin.TilemapWalker(this.game,this.map,this.map.currentLayer,1,14),this.buildView(),this.cursors=game.input.keyboard.createCursorKeys(),this.cursors.up.onDown.add(this.moveForward,this),this.cursors.down.onDown.add(this.showMap,this),this.cursors.left.onDown.add(this.turnLeft,this),this.cursors.right.onDown.add(this.turnRight,this)},checkCurrentTile:function(){var a=this.walker.getTile();console.log("current tile is",a),a&&(3===a.index?this.walker.putTile(-1):4===a.index?(this.keys++,this.walker.putTile(-1)):8===a.index&&(this.gold++,this.walker.putTile(-1)))},moveForward:function(){return this.mapImage.visible?void this.hideMap():void(3===this.walker.getTileAhead().index?(this.keys>0&&this.keys--,this.walker.moveForward()&&(console.log("\nmoveForward through locked door"),this.buildView(),this.checkCurrentTile())):this.walker.moveForward()&&(console.log("\nmoveForward"),this.buildView(),this.checkCurrentTile()))},moveBackward:function(){this.walker.moveBackward(),console.log("\nmoveBackward"),this.buildView(),this.checkCurrentTile()},turnLeft:function(){return this.mapImage.visible?void this.hideMap():(this.walker.turnLeft(),console.log("\nturnLeft"),void this.buildView())},turnRight:function(){return this.mapImage.visible?void this.hideMap():(this.walker.turnRight(),console.log("\nturnRight"),void this.buildView())},buildView:function(){console.log("X:",this.walker.location.x,"Y:",this.walker.location.y,"\n"),this.wall0.frame=0===this.wall0.frame?1:0,this.wall1.visible=!1,this.wall2.visible=!1,this.wall3.visible=!1,this.wall4.visible=!1,this.wall5.visible=!1,this.wall6.visible=!1,this.wall7.visible=!1,this.wall8.visible=!1,this.lock3.visible=!1,this.lock6.visible=!1,this.key3.visible=!1,this.key6.visible=!1,this.potion3.visible=!1,this.potion6.visible=!1,this.frog3.visible=!1,this.frog6.visible=!1,this.gold3.visible=!1,this.gold6.visible=!1,this.nsew.frame=this.walker.facing;var a=this.walker.getTiles(3,3),b=0;for(y=0;3>y;y++)for(x=0;3>x;x++)b=a[y][x],2===b?this.walls[y][x].visible=!0:3===b?1===x&&0===y?this.lock3.visible=!0:1===x&&1===y?this.lock6.visible=!0:this.walls[y][x].visible=!0:4===b?1===x&&0===y?this.key3.visible=!0:1===x&&1===y&&(this.key6.visible=!0):5===b?1===x&&0===y?this.potion3.visible=!0:1===x&&1===y&&(this.potion6.visible=!0):6===b?1===x&&0===y?this.frog3.visible=!0:1===x&&1===y&&(this.frog6.visible=!0):8===b&&(1===x&&0===y?this.gold3.visible=!0:1===x&&1===y&&(this.gold6.visible=!0))},showMap:function(){return this.mapImage.visible?void this.hideMap():(this.buildMap(),void(this.mapImage.visible=!0))},hideMap:function(){this.mapImage.visible=!1},buildMap:function(){this.mapBMD.fill(110,110,110,1);var a=this.walker.getMiniMap(16,16),b=0,c=0,d=0;for(y=0;16>y;y++){for(x=0;16>x;x++)b=a.tiles[y][x],b>=0&&2>=b&&this.mapBMD.rect(c,d,2,2,this.mapColors[b]),c+=2;c=0,d+=2}for(c=0,d=0,y=0;16>y;y++){for(x=0;16>x;x++)b=a.tiles[y][x],b>2&&7>b&&(this.mapBMD.rect(c,d,2,3,this.mapShadow),this.mapBMD.rect(c,d,2,2,this.mapColors[b])),c+=2;c=0,d+=2}this.mapBMD.rect(2*a.walker.x,2*a.walker.y,2,3,this.mapShadow),this.mapBMD.rect(2*a.walker.x,2*a.walker.y,2,2,"#ffffff")},update:function(){this.keysFont.text=this.keys.toString(),this.goldFont.text=this.gold.toString()},render:function(){TimesOfLores.pixelContext.drawImage(game.canvas,0,0,32,32,0,0,TimesOfLores.width,TimesOfLores.height)}};